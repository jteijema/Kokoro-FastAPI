name: Release

on:
  push:
    branches: [ "main", "master" ]

jobs:
  prepare:
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.get_version.outputs.version }}
    steps:
      - uses: actions/checkout@v3
      
      - name: Get version
        id: get_version
        run: |
          VERSION=$(cat VERSION | tr -d '\n')
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Building version: $VERSION"

  build-images:
    needs: prepare
    runs-on: ubuntu-latest
    timeout-minutes: 60 
    strategy:
      fail-fast: false  # Continue with other builds if one fails
      matrix:
        include:
          - type: gpu
            dockerfile: ./Dockerfile
            context: .
            suffix: ""
          - type: cpu
            dockerfile: ./Dockerfile.cpu
            context: .
            suffix: "-cpu"
          - type: gui
            dockerfile: ./ui/Dockerfile
            context: ./ui
            suffix: "-gui"
    steps:
    - uses: actions/checkout@v3
    
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
      
    - name: Login to Docker Hub
      uses: docker/login-action@v3
      with:
        username: ${{ secrets.DOCKERHUB_USERNAME }}
        password: ${{ secrets.DOCKERHUB_TOKEN }}
      
    - name: Build and push ${{ matrix.type }}
      id: docker_build
      uses: docker/build-push-action@v5
      with:
        context: ${{ matrix.context }}
        file: ${{ matrix.dockerfile }}
        push: true
        tags: |
          ${{ secrets.DOCKERHUB_USERNAME }}/kokoro-fastapi:latest${{ matrix.suffix }}
          ${{ secrets.DOCKERHUB_USERNAME }}/kokoro-fastapi:v${{ needs.prepare.outputs.version }}${{ matrix.suffix }}
        cache-from: type=registry,ref=${{ secrets.DOCKERHUB_USERNAME }}/kokoro-fastapi:buildcache${{ matrix.suffix }}
        cache-to: type=registry,ref=${{ secrets.DOCKERHUB_USERNAME }}/kokoro-fastapi:buildcache${{ matrix.suffix }},mode=max
        platforms: ${{ matrix.type == 'gpu' && 'linux/amd64' || 'linux/amd64,linux/arm64' }}

    - name: Image digest
      run: echo ${{ steps.docker_build.outputs.digest }}

  create-release:
    needs: [prepare, build-images]
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3
    
    - name: Create Release
      uses: actions/create-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: v${{ needs.prepare.outputs.version }}
        release_name: Release v${{ needs.prepare.outputs.version }}
        body: |
          Release v${{ needs.prepare.outputs.version }}
          
          Docker images:

          GPU (AMD64 only):
          - kokoro-fastapi:latest
          - kokoro-fastapi:v${{ needs.prepare.outputs.version }}

          CPU (AMD64 + ARM64):
          - kokoro-fastapi:latest-cpu
          - kokoro-fastapi:v${{ needs.prepare.outputs.version }}-cpu

          GUI (AMD64 + ARM64):
          - kokoro-fastapi:latest-gui
          - kokoro-fastapi:v${{ needs.prepare.outputs.version }}-gui

          Note: CPU and GUI images support both x86_64 and ARM architectures (M1/M2 Macs)
        draft: false
        prerelease: false
